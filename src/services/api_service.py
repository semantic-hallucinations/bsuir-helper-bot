import asyncio
import json

import httpx
from environs import Env

from config import get_logger

from .message_formatter import format_rag_agent_response

env = Env()
env.read_env()

logger = get_logger("bot.services")


class ApiService:
    RAG_AGENT_API_URL = env.str("RAG_AGENT_API_URL")
    MAX_RETRIES = 3

    @classmethod
    async def get_response(cls, query: str) -> str:
        for attempt in range(cls.MAX_RETRIES):
            try:
                async with httpx.AsyncClient(timeout=120.0) as client:
                    response = await client.post(
                        cls.RAG_AGENT_API_URL,
                        content=json.dumps(query),
                        headers={"Content-Type": "application/json"},
                    )
                    response.raise_for_status()
                    return format_rag_agent_response(response.json())
            except (httpx.RequestError, httpx.HTTPStatusError) as e:
                logger.warning(f"Attempt {attempt + 1} failed: {str(e)}")
                if attempt == cls.MAX_RETRIES - 1:
                    logger.error("All retry attempts failed")
                    raise RuntimeError("Failed to get response from RAG-service") from e
                await asyncio.sleep(2**attempt * 3)


#     @classmethod
#     async def get_response(cls, query:str) -> str:
#         broken_markdowns = [
#         "–≠—Ç–æ *–≤–∞–∂–Ω—ã–π —Ç–µ–∫—Å—Ç, –Ω–æ –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–≤—ë–∑–¥–æ—á–∫–∏",
#         "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ _–∫—É—Ä—Å–∏–≤–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –±–µ–∑ –∫–æ–Ω—Ü–∞",
#         "–°—Å—ã–ª–∫–∞ –±–µ–∑ –∫–æ–Ω—Ü–∞ [–ø—Ä–∏–º–µ—Ä —Å—Å—ã–ª–∫–∏(https://example.com)",
#         "*–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç **–≤–ª–æ–∂–µ–Ω–Ω—ã–π* –Ω–æ —Å–ª–æ–º–∞–Ω",
#         "```–∫–æ–¥ –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è",
#         "–í–æ—Ç `–æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∫–æ–¥ —Å –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–º —Å–∏–º–≤–æ–ª–æ–º",
#         "–ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å __–ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ__ –∏ _–∫—É—Ä—Å–∏–≤",  # –ª–∏—à–Ω—è—è –Ω–∏–∂–Ω—è—è —á–µ—Ä—Ç–∞
#         "–°–ø–∏—Å–æ–∫:\n- –ø—É–Ω–∫—Ç 1\n- –ø—É–Ω–∫—Ç *—Å –æ—à–∏–±–∫–æ–π\n- –ø—É–Ω–∫—Ç 3",
#         "–í–æ—Ç [—Å—Å—ã–ª–∫–∞](https://example.com –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–∫–æ–±–∫–∏",
#         "–í–æ—Ç –ø—Ä–∏–º–µ—Ä ***–∂–∏—Ä–Ω–æ–≥–æ –∏ –∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ**, –Ω–æ –ø–æ–ª–æ–º–∞–Ω",
#         "–ù–µ–≤–∞–ª–∏–¥–Ω–∞—è —Å—Å—ã–ª–∫–∞: [—Ç–µ–∫—Å—Ç](ht@tp://bad_url)",
#         "–ö–∞—Ä—Ç–∏–Ω–∫–∞ –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è ![alt —Ç–µ–∫—Å—Ç](image.png",
#         "~~–∑–∞—á—ë—Ä–∫–Ω—É—Ç–æ, –Ω–æ –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è",
#         "–í–ª–æ–∂–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: *—Ç–µ–∫—Å—Ç _–≤–Ω—É—Ç—Ä–∏ –±–µ–∑ –∫–æ–Ω—Ü–∞*",
#         "–ñ–∏—Ä–Ω—ã–π —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º\\*–∑–≤–µ–∑–¥–∞ –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è",
#         "–ú–Ω–æ–≥–æ **–æ—Ç–∫—Ä—ã—Ç–∏–π *–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç* –ø–∞—Ä–Ω—ã—Ö",
#         "–û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –ª–∏—à–Ω–∏–º `–æ–¥–Ω–∏–º –±—ç–∫—Ç–∏–∫–æ–º",
#         "–ü—Ä–æ–±–ª–µ–º–Ω—ã–π [–ª–∏–Ω–∫](https://example.com) –∏ *–∫—É—Ä—Å–∏–≤",
#         "## –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ –ø—Ä–æ–±–µ–ª–∞",
#         "- –ø—É–Ω–∫—Ç —Å _–∫—É—Ä—Å–∏–≤–æ–º\n- –≤—Ç–æ—Ä–æ–π —Å **–∂–∏—Ä–Ω—ã–º",
#     ]
#         return (
#     "**–í –ë–ì–£–ò–† *–±–ª–∏–Ω—á–∏–∫–∏* –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö:**\n\n"
#     "**1. –°—Ç–æ–ª–æ–≤—ã–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞**\n"
#     "–í –º–µ–Ω—é —Å—Ç–æ–ª–æ–≤—ã—Ö ‚Ññ1, ‚Ññ2 –∏ ‚Ññ3 –∏–Ω–æ–≥–¥–∞ –±—ã–≤–∞—é—Ç –±–ª–∏–Ω—á–∏–∫–∏ (–æ–±—ã—á–Ω–æ –≤ —É—Ç—Ä–µ–Ω–Ω–∏–µ —á–∞—Å—ã –∏–ª–∏ –∫–∞–∫ –¥–µ—Å–µ—Ä—Ç).\n"
#     "üîπ **–°—Å—ã–ª–∫–∏ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–µ–Ω—é:**\n"
#     "- [–°—Ç–æ–ª–æ–≤–∞—è ‚Ññ1](https://www.bsuir.by/m/12_100229_1_194548.xls)\n"
#     "- [–°—Ç–æ–ª–æ–≤–∞—è ‚Ññ2](https://www.bsuir.by/m/12_100229_1_194547.xls)\n"
#     "- [–°—Ç–æ–ª–æ–≤–∞—è ‚Ññ3](https://www.bsuir.by/m/12_100229_1_194546.xls)\n\n"
#     "**2. –ë—É—Ñ–µ—Ç—ã –∏ –∫–æ—Ñ–µ–π–Ω–∏**\n"
#     "–í –∫–æ—Ä–ø—É—Å–∞—Ö –∏ –æ–±—â–µ–∂–∏—Ç–∏—è—Ö –µ—Å—Ç—å –±—É—Ñ–µ—Ç—ã –∏ –∫–æ—Ñ–µ–π–Ω–∏, –≥–¥–µ –º–æ–≥—É—Ç –ø–æ–¥–∞–≤–∞—Ç—å –±–ª–∏–Ω—á–∏–∫–∏ "
#     "(–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –∫–æ—Ñ–µ–π–Ω–µ 4-–≥–æ –∫–æ—Ä–ø—É—Å–∞ –∏–ª–∏ –±—É—Ñ–µ—Ç–µ 5-–≥–æ –∫–æ—Ä–ø—É—Å–∞).\n\n"
#     "**3. –°—Ç–æ–ª–æ–≤—ã–µ –æ–±—â–µ–∂–∏—Ç–∏–π**\n"
#     "–í —Å—Ç–æ–ª–æ–≤—ã—Ö –ø—Ä–∏ –æ–±—â–µ–∂–∏—Ç–∏—è—Ö (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ ‚Ññ3 –∏ ‚Ññ5) –∏–Ω–æ–≥–¥–∞ –≥–æ—Ç–æ–≤—è—Ç –±–ª–∏–Ω—á–∏–∫–∏.\n\n"
#     "**4. –í –¥–Ω–∏ –∞–∫—Ü–∏–π –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π**\n"
#     "–í–æ –≤—Ä–µ–º—è —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏—Ö –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –∏–ª–∏ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–Ω–µ–π –≤ —Å—Ç–æ–ª–æ–≤—ã—Ö –º–æ–≥—É—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å "
#     "–±–ª–∏–Ω—á–∏–∫–∏ –ø–æ —Å–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é.\n\n"
#     "**–°–æ–≤–µ—Ç:** –ï—Å–ª–∏ –≤ –º–µ–Ω—é –Ω–µ—Ç –±–ª–∏–Ω—á–∏–∫–æ–≤, —É—Ç–æ—á–Ω–∏—Ç–µ —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –≤ –∫–∞–∫–∏–µ –¥–Ω–∏ –∏—Ö –≥–æ—Ç–æ–≤—è—Ç.\n\n"
#     "–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç–æ–ª–æ–≤—É—é –∏–ª–∏ –∫–æ—Ä–ø—É—Å? –£—Ç–æ—á–Ω–∏—Ç–µ ‚Äì –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç! üòä\n\n"
#     "–ò—Å—Ç–æ—á–Ω–∏–∫–∏:\n"
#     "https://www.bsuir.by/ru/obosoblennoe-podrazdelenie-bguir-kombinat-pitaniya\n"
#     "https://www.bsuir.by/ru/spetsialnosti-bguir\n"
#     "https://www.bsuir.by/ru/brsm-bguir\n"
#     "https://www.bsuir.by/ru/molodezhnye-obedineniya/volonterskiy-tsentr-bguir\n"
#     "https://www.bsuir.by/ru/bguir-v-pechati-za-sentyabr-2019\n"
#     "https://www.bsuir.by/ru/sotsialnaya-podderzhka"
# )
